<html>
  <head>
    <title>Wikipedia Live Monitor</title>
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script src="humane.js"></script>
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <h1>Wikipedia Live Monitor</h1>
    <div class="settings-container">
      <h2>Settings</h2>
      <div class="settings">
        <input id="breakingNewsThreshold" type="range" min="1" max="10" step="1" />
        <span class="value" id="breakingNewsThresholdValue"></span>
        <label for="breakingNewsThreshold">Breaking News Threshold</label>
        <br/>
        <small class="hint">An article cluster must have at least <i>n</i> edits before it is
        considered a breaking news candidate.</small>
      </div>

      <div class="settings">
        <input id="secondsBetweenEdits" type="range" min="10" max="120" step="10" />
        <span class="value" id="secondsBetweenEditsValue"></span>
        <label for="secondsBetweenEdits">Seconds Between Edits</label>
        <br/>
        <small class="hint">An article cluster may have at max <i>n</i> seconds in between
        edits in order to be regarded a breaking news candidate.</small>
      </div>

      <div class="settings">
        <input id="numberOfConcurrentEditors" type="range" min="1" max="5" step="1" />
        <span class="value" id="numberOfConcurrentEditorsValue"></span>
        <label for="numberOfConcurrentEditors">Number of Concurrent Editors</label>
        <br/>
        <small class="hint">An article cluster must be edited by at least <i>n</i> concurrent
        editors before it is considered a breaking news candidate.</small>
      </div>

      <div class="settings">
        <input id="secondsSinceLastEdit" type="range" min="10" max="480" step="10" />
        <span class="value" id="secondsSinceLastEditValue"></span>
        <label for="secondsSinceLastEdit">Seconds Since Last Edit</label>
        <br/>
        <small class="hint">An article cluster is thrown out of the monitoring loop if its last
        edit is longer ago than <i>n</i> seconds.</small>
      </div>

      <div>
        <button id="reset">Reset</button>
      </div>
    </div>

    <h2>Articles edited right now:</h2>
    <div id="firstTimeSeen"></div>

    <h2>Article clusters concurrently repeatedly edited in short intervals:</h2>
    <div id="nTimesSeen"></div>

    <h2>Breaking news candidates article clusters right now:</h2>
    <div id="breakingNewsCandidates"></div>

    <small>
      <div id="stats"></div>
    </small>

    <script>
      var reset = document.querySelector('#reset');
      reset.addEventListener('click', function(e) {
        document.querySelector('#secondsSinceLastEdit')
        .value = 240;
        document.querySelector('#secondsSinceLastEditValue')
        .innerHTML = 240;

        document.querySelector('#secondsBetweenEdits')
        .value = 60;
        document.querySelector('#secondsBetweenEditsValue')
        .innerHTML = 60;

        document.querySelector('#breakingNewsThreshold')
        .value = 5;
        document.querySelector('#breakingNewsThresholdValue')
        .innerHTML = 5;

        document.querySelector('#numberOfConcurrentEditors')
        .value = 2;
        document.querySelector('#numberOfConcurrentEditorsValue')
        .innerHTML = 2;

        socket.emit('secondsSinceLastEdit', {
          value: secondsSinceLastEdit.value
        });

        socket.emit('breakingNewsThreshold', {
          value: breakingNewsThreshold.value
        });

        socket.emit('numberOfConcurrentEditors', {
          value: numberOfConcurrentEditors.value
        });

        socket.emit('secondsBetweenEdits', {
          value: secondsBetweenEdits.value
        });
      }, false);

      var secondsSinceLastEdit =
          document.querySelector('#secondsSinceLastEdit');
      var secondsSinceLastEditValue =
          document.querySelector('#secondsSinceLastEditValue');
      secondsSinceLastEdit.addEventListener('change', function(e) {
        secondsSinceLastEditValue.innerHTML = secondsSinceLastEdit.value;
        socket.emit('secondsSinceLastEdit', {
          value: secondsSinceLastEdit.value
        });
      }, false);

      var secondsBetweenEdits =
          document.querySelector('#secondsBetweenEdits');
      var secondsBetweenEditsValue =
          document.querySelector('#secondsBetweenEditsValue');
      secondsBetweenEdits.addEventListener('change', function(e) {
        secondsBetweenEditsValue.innerHTML = secondsBetweenEdits.value;
        socket.emit('secondsBetweenEdits', {
          value: secondsBetweenEdits.value
        });
      }, false);

      var numberOfConcurrentEditors =
          document.querySelector('#numberOfConcurrentEditors');
      var numberOfConcurrentEditorsValue =
          document.querySelector('#numberOfConcurrentEditorsValue');
      numberOfConcurrentEditors.addEventListener('change', function(e) {
        numberOfConcurrentEditorsValue.innerHTML =
            numberOfConcurrentEditors.value;
        socket.emit('numberOfConcurrentEditors', {
          value: numberOfConcurrentEditors.value
        });
      }, false);

      var breakingNewsThreshold =
          document.querySelector('#breakingNewsThreshold');
      var breakingNewsThresholdValue =
          document.querySelector('#breakingNewsThresholdValue');
      breakingNewsThreshold.addEventListener('change', function(e) {
        breakingNewsThresholdValue.innerHTML = breakingNewsThreshold.value;
        socket.emit('breakingNewsThreshold', {
          value: breakingNewsThreshold.value
        });
      }, false);

      // converts an article like en:Albert_Einstein to a valid Wikipedia link
      // like so: http://en.wikipedia.org/wiki/Albert_Einstein
      function linkifyTitle(text) {
        var components = text.split(':');
        return '<a class="title" href="http://' + components[0] + '.wikipedia.org/wiki/' +
            components[1] + '">' + components[1].replace(/_/g, ' ') + '</a>';
      }

      // converts a user name like en:Jon_Doe to a valid Wikipedia user profile
      // link like so: http://en.wikipedia.org/wiki/User:Jon_Doe. Ignore
      // anonymous users
      function linkifyUser(user) {
        var components = user.split(':');
        if (/\b(?:\d{1,3}\.){3}\d{1,3}\b/.test(user)) {
          return components[1];
        }
        return '<a class="user" href="http://' + components[0] +
            '.wikipedia.org/wiki/User:' + components[1] + '">' + components[1] +
            '</a>';
      }

      function formatLanguages(languages) {
        var languagesArray = [];
        for(var language in languages) {
          var obj = {
            language: language,
            count: languages[language]
          };
          languagesArray.push(obj);
        }
        languagesArray.sort(function(a, b) { return b.count - a.count; });
        var html = '';
        languagesArray.forEach(function(lang, i) {
          html += (i > 0? ', ' : '') + '<b>' + lang.language + '</b>: ' +
              lang.count;
        });
        return html;
      }

      function logFirstTimeSeen(data) {
        var firstTimeSeen = document.querySelector('#firstTimeSeen');
        if (firstTimeSeen.childNodes.length > 4) {
          firstTimeSeen.removeChild(firstTimeSeen.firstChild);
        }
        firstTimeSeen.innerHTML +=
            '<li>' +
              '<strong class="title">' + linkifyTitle(data.article) + '</strong> ' +
              '(' + humaneDate(data.timestamp) + '). ' +
              '<br/><b>Editor:</b> ' + data.editors.map(linkifyUser) + '. ' +
              '<b>Language:</b> ' + Object.keys(data.languages) + '.' +
            '</li>';
      }

      function generateLogMessage(data) {
        var html =
            '<li>' +
              '<strong class="title">' + linkifyTitle(data.article) + '</strong> ' +
              '(' + humaneDate(data.timestamp) + '), ' +
              '<br/><b>Versions:</b> ' + Object.keys(data.versions)
              .map(linkifyTitle)
              .toString().replace(/,/g, ', ') + '. ' +
              '<br/><b>Edit Intervals:</b> ' +
              data.editIntervals.map(function(interval) {
                return ~~(interval / 1000) + 'sec';
              }).toString().replace(/,/g, ', ') + '. ' +
              '<br/><b>Occurrences:</b> ' + data.occurrences + '. ' +
              '<br/><b>Editors:</b> ' + data.editors.map(linkifyUser).toString()
              .replace(/,/g, ', ') + '. ' +
              '<br/><b>Languages:</b> ' + formatLanguages(data.languages) + '. ' +
              '<br/><b>Changes:</b> ' +
              Object.keys(data.changes).map(function(timestamp) {
                var humane = humaneDate(new Date(parseInt(timestamp, 10)));
                var url = data.changes[timestamp].diffUrl;
                return '<a href="' + url + '">' + humane + '</a> ' +
                    '(' + data.changes[timestamp].delta + ')';
              }).toString().replace(/,/g, ', ') + '.'
            '</li>';
        return html;
      }

      function logNTimesSeen(data) {
        var nTimesSeen = document.querySelector('#nTimesSeen');
        if (nTimesSeen.childNodes.length > 4) {
          nTimesSeen.removeChild(nTimesSeen.firstChild);
        }
        nTimesSeen.innerHTML += generateLogMessage(data);
      }

      function logBreakingNewsCandidate(data) {
        var breakingNewsCandidate =
            document.querySelector('#breakingNewsCandidates');
        if (breakingNewsCandidate.childNodes.length > 4) {
          breakingNewsCandidate.removeChild(breakingNewsCandidate.firstChild);
        }
        breakingNewsCandidate.innerHTML += generateLogMessage(data);
      }

      function logStats(data) {
        var stats = document.querySelector('#stats');
        stats.innerHTML =
            '<strong>Article clusters in the monitoring loop:</strong> ' +
            data.clustersLeft;
      }

      var socket = io.connect('http://localhost:8080');

      socket.on('defaultSettings', function(data) {
        document.querySelector('#secondsSinceLastEdit')
        .value = data.secondsSinceLastEdit;
        document.querySelector('#secondsSinceLastEditValue')
        .innerHTML = data.secondsSinceLastEdit;

        document.querySelector('#secondsBetweenEdits')
        .value = data.secondsBetweenEdits;
        document.querySelector('#secondsBetweenEditsValue')
        .innerHTML = data.secondsBetweenEdits;

        document.querySelector('#breakingNewsThreshold')
        .value = data.breakingNewsThreshold;
        document.querySelector('#breakingNewsThresholdValue')
        .innerHTML = data.breakingNewsThreshold;

        document.querySelector('#numberOfConcurrentEditors')
        .value = data.numberOfConcurrentEditors;
        document.querySelector('#numberOfConcurrentEditorsValue')
        .innerHTML = data.numberOfConcurrentEditors;

      });

      socket.on('firstTimeSeen', function(data) {
        logFirstTimeSeen(data);
      });

      socket.on('nTimesSeen', function(data) {
        logNTimesSeen(data);
      });

      socket.on('breakingNewsCandidate', function(data) {
        logBreakingNewsCandidate(data);
      });

      socket.on('stats', function(data) {
        logStats(data);
      });

    </script>
  </body>
</html>